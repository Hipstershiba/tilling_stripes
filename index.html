<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Sketch</title>

  <link rel="stylesheet" type="text/css" href="style.css">

  <script src="libraries/p5.min.js"></script>
  <script src="libraries/p5.sound.min.js"></script>
  <script src="libraries/simple-svg.js"></script>
</head>

<body>

  <div id="main-container">
    <!-- Backdrop for mobile menu -->
    <div id="overlay-backdrop"></div>

    <button id="btnMobileToggle" class="ui-toggle-btn" title="Open Controls">☰</button>

    <div id="controls">
      <!-- Close button for mobile -->
      <button id="btnCloseControls"
        style="position:absolute; right:15px; top:15px; width:40px; background:transparent; border:none; color:#aaa; font-size:1.5rem; cursor:pointer; display:none;">✕</button>

      <h1>Pattern Gen</h1>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="setup">Setup</button>
        <button class="tab-btn" data-tab="interact">Interact</button>
      </div>

      <!-- TAB CONTENT: SETUP -->
      <div id="tab-setup" class="tab-content active">

        <div class="control-group">
          <label>Canvas Size</label>
          <div class="row">
            <input type="number" id="canvasW" value="600" step="50">
            <span>x</span>
            <input type="number" id="canvasH" value="600" step="50">
            <button id="btnLockCanvasRatio" title="Lock Aspect Ratio"
              style="width:30px; padding:0; display:flex; justify-content:center; align-items:center;">
              <!-- Default Unlock Icon -->
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
              </svg>
            </button>
          </div>
          <button id="btnFitScreen" style="margin-top:5px; width:100%">Fit to Screen</button>
          <button id="btnFitCanvas" style="margin-top:5px; width:100%">Fit Canvas to Grid</button>
        </div>

        <div class="control-group">
          <label>Grid (Rows x Cols)</label>
          <div class="row">
            <input type="number" id="gridRows" value="4" min="1" max="50">
            <span>x</span>
            <input type="number" id="gridCols" value="4" min="1" max="50">
            <button id="btnLockGridRatio" title="Lock Aspect Ratio"
              style="width:30px; padding:0; display:flex; justify-content:center; align-items:center;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
              </svg>
            </button>
          </div>
          <button id="btnSquareGrid" style="margin-top:5px; width:100%">Square Cells</button>
        </div>

        <div class="control-group">
          <label>Margin (px)</label>
          <input type="number" id="gridMargin" value="0" min="0" step="10">
        </div>

        <div class="control-group">
          <label>Seed</label>
          <div class="row">
            <input type="number" id="seedInput" value="0">
            <button id="btnRandomize" style="display:flex; justify-content:center; align-items:center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" y1="20" x2="21" y2="3"></line>
                <polyline points="21 16 21 21 16 21"></polyline>
                <line x1="15" y1="15" x2="21" y2="21"></line>
                <line x1="4" y1="4" x2="9" y2="9"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="control-group tile-selector-group">
          <label>Allowed Tiles</label>
          <div id="tileSelector">
            <!-- Javascript will populate this -->
          </div>
          <div class="row">
            <button id="selectAll">All</button>
            <button id="selectNone">None</button>
          </div>
        </div>

      </div> <!-- End Tab Setup -->

      <!-- TAB CONTENT: INTERACT -->
      <div id="tab-interact" class="tab-content">
        <!-- Improved Interaction Controls -->
        <div class="control-group">
          <label>Interaction Mode</label>
          <div class="mode-toggle-group">
            <button id="modeNone" class="mode-btn active" data-mode="none" title="View Only"
              style="display:flex; justify-content:center; align-items:center; gap:5px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              View
            </button>
            <button id="modeMirror" class="mode-btn" data-mode="mirror" title="Cycle Family"
              style="display:flex; justify-content:center; align-items:center; gap:5px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Cycle
            </button>
            <button id="modeEdit" class="mode-btn" data-mode="edit" title="Paint Tile"
              style="display:flex; justify-content:center; align-items:center; gap:5px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
                <circle cx="11" cy="11" r="2"></circle>
              </svg>
              Paint
            </button>
          </div>

          <div id="scopeControl" style="margin-top: 10px; display:none;">
            <label style="font-size: 0.8rem; color: #aaa;">Scope</label>
            <div class="scope-toggle-group" style="display: flex; flex-wrap: wrap; gap: 5px;">
              <button id="scopeSingle" class="scope-btn active" data-scope="single"
                style="flex: 1 1 40%; font-size: 0.8rem;">Single</button>
              <button id="scopeSupertile" class="scope-btn" data-scope="supertile"
                style="flex: 1 1 40%; font-size: 0.8rem;">Supertile</button>
              <button id="scopeGlobalExact" class="scope-btn" data-scope="global_exact"
                style="flex: 1 1 90%; font-size: 0.8rem;">Global Exact</button>

              <div style="flex: 1 1 100%; border-top: 1px solid #444; margin: 4px 0;"></div>

              <button id="scopeGlobalPos" class="scope-btn" data-scope="global_pos"
                style="flex: 1 1 45%; font-size: 0.8rem;">Global Pos (Single)</button>
              <button id="scopeGlobalPosSym" class="scope-btn" data-scope="global_pos_sym"
                style="flex: 1 1 45%; font-size: 0.8rem;">Global Pos (Batch)</button>
            </div>
            <div id="scopeDesc" style="font-size: 0.7rem; color: #777; margin-top: 4px; line-height: 1.2;">
              Global Exact: Replace all tiles of same type. <br>
              Pos (S): Updates 1 quadrant in all supertiles. <br>
              Pos (B): Updates all 4 symmetric quadrants in all supertiles.
            </div>
          </div>

          <div id="paintTileDisplay"
            style="margin-top:10px; display:none; flex-direction: column; background: #2a2a2a; border-radius: 4px; padding: 8px; border: 1px solid #444;">
            <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Active Brush:</div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <!-- Preview Icon -->
              <div id="paintTilePreview"
                style="width: 30px; height: 30px; background: #333; border: 1px solid #555; border-radius: 4px; overflow: hidden;">
              </div>
              <span id="paintTileName" style="font-size: 0.9rem; font-weight: bold; color: #fff;"> Select below </span>
            </div>

            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
              <label style="font-size: 0.8rem; color: #aaa; display:block; margin-bottom: 5px;">Brush Palette:</label>
              <div id="brushList" class="tile-list"
                style="max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 4px;">
                <!-- Brush tiles injected here -->
              </div>
            </div>
          </div>
        </div>
      </div> <!-- End Tab Interact -->



      <div class="control-group actions">
        <button id="btnSave">Save Image</button>
        <button id="btnSaveSVG">Save SVG</button>
      </div>
    </div>

    <div id="canvas-container">
      <button id="btnFullscreen" title="Toggle Fullscreen"
        style="display:flex; justify-content:center; align-items:center;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
          </path>
        </svg>
      </button>
    </div>
  </div> <!-- End main-container -->

  <script src="tile_registry.js"></script>
  <script src="tile_transforms.js"></script>
  <script src="subtile.js"></script>
  <script src="tiles.js"></script>
  <script src="supertile.js"></script>
  <script src="sketch.js"></script>
  <script>
    // Responsive Sidebar Logic
    document.addEventListener('DOMContentLoaded', () => {
      const btnToggle = document.getElementById('btnMobileToggle');
      const controls = document.getElementById('controls');
      const backdrop = document.getElementById('overlay-backdrop');
      const body = document.body;

      function toggleSidebar() {
        if (!controls) return;

        const isMobile = window.innerWidth <= 768; // Matches CSS breakpoint

        if (isMobile) {
          // Mobile behavior: Toggle drawer open/close
          const isOpen = controls.classList.contains('open');
          if (isOpen) {
            controls.classList.remove('open');
            if (backdrop) {
              backdrop.style.opacity = '0';
              setTimeout(() => backdrop.style.display = 'none', 300);
            }
          } else {
            controls.classList.add('open');
            if (backdrop) {
              backdrop.style.display = 'block';
              setTimeout(() => backdrop.style.opacity = '1', 10);
            }
          }
        } else {
          // Desktop behavior: Toggle visibility (Zen Mode vs Normal)
          const isClosed = controls.classList.contains('closed');
          if (isClosed) {
            controls.classList.remove('closed');
            body.classList.remove('sidebar-closed');
            btnToggle.classList.remove('closed-state');
          } else {
            controls.classList.add('closed');
            body.classList.add('sidebar-closed');
            btnToggle.classList.add('closed-state');
          }
        }
      }

      if (btnToggle) btnToggle.addEventListener('click', toggleSidebar);

      // Close on backdrop click (for mobile)
      if (backdrop) backdrop.addEventListener('click', toggleSidebar);

      // Handle resize to reset states if needed
      window.addEventListener('resize', () => {
        // Optional: Reset states if crossing breakpoint to avoid weirdness
        // For now, simpler is better.
      });

      // Tab Switching Logic
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from buttons
          tabs.forEach(t => t.classList.remove('active'));
          // Add active to clicked
          tab.classList.add('active');

          // Hide all contents
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          // Show target content
          const targetId = 'tab-' + tab.getAttribute('data-tab');
          document.getElementById(targetId).classList.add('active');
        });
      });
    });
  </script>
</body>

</html>