<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Sketch</title>

  <link rel="stylesheet" type="text/css" href="style.css">

  <script src="libraries/p5.min.js"></script>
  <script src="libraries/p5.sound.min.js"></script>
  <script src="libraries/simple-svg.js"></script>
</head>

<body>

  <div id="main-container">
    <!-- Backdrop for mobile menu -->
    <div id="overlay-backdrop"></div>

    <button id="btnMobileToggle" class="ui-toggle-btn" title="Open Controls">☰</button>

    <div id="controls">
      <!-- Close button for mobile -->
      <button id="btnCloseControls"
        style="position:absolute; right:15px; top:15px; width:40px; background:transparent; border:none; color:#aaa; font-size:1.5rem; cursor:pointer; display:none;">✕</button>

      <h1>Pattern Gen</h1>

      <!-- Tab Navigation -->
      <div class="tab-nav" data-active="setup">
        <div class="tab-nav-bg"></div>
        <button class="tab-btn active" data-tab="setup">Setup</button>
        <button class="tab-btn" data-tab="edit">Edit</button>
      </div>

      <!-- TAB CONTENT: SETUP -->
      <div id="tab-setup" class="tab-content active">

        <div class="control-group">
          <label>
            <span>Canvas Size</span>
            <span class="group-summary"></span>
          </label>
          <div class="group-content">
            <div class="row">
              <input type="number" id="canvasW" value="600" step="50">
              <span>x</span>
              <input type="number" id="canvasH" value="600" step="50">
              <button id="btnLockCanvasRatio" title="Lock Aspect Ratio"
                style="width:30px; padding:0; display:flex; justify-content:center; align-items:center;">
                <!-- Default Unlock Icon -->
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                </svg>
              </button>
            </div>
            <button id="btnFitScreen" style="margin-top:5px; width:100%">Fit to Screen</button>
            <button id="btnFitCanvas" style="margin-top:5px; width:100%">Fit Canvas to Grid</button>
          </div>
        </div>

        <div class="control-group">
          <label>
            <span>Grid (Rows x Cols)</span>
            <span class="group-summary"></span>
          </label>
          <div class="group-content">
            <div class="row">
              <input type="number" id="gridRows" value="4" min="1" max="50">
              <span>x</span>
              <input type="number" id="gridCols" value="4" min="1" max="50">
              <button id="btnLockGridRatio" title="Lock Aspect Ratio"
                style="width:30px; padding:0; display:flex; justify-content:center; align-items:center;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                </svg>
              </button>
            </div>
            <button id="btnSquareGrid" style="margin-top:5px; width:100%">Square Cells</button>
          </div>
        </div>

        <div class="control-group">
          <label>
            <span>Margin (px)</span>
            <span class="group-summary"></span>
          </label>
          <div class="group-content">
            <input type="number" id="gridMargin" value="0" min="0" step="10">
          </div>
        </div>

        <div class="control-group">
          <label>
            <span>Seed</span>
            <span class="group-summary"></span>
          </label>
          <div class="group-content">
            <div class="row">
              <input type="number" id="seedInput" value="0">
              <button id="btnRandomize" style="display:flex; justify-content:center; align-items:center;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="16 3 21 3 21 8"></polyline>
                  <line x1="4" y1="20" x2="21" y2="3"></line>
                  <polyline points="21 16 21 21 16 21"></polyline>
                  <line x1="15" y1="15" x2="21" y2="21"></line>
                  <line x1="4" y1="4" x2="9" y2="9"></line>
                </svg>
              </button>
            </div>

            <!-- History Controls for Generation -->
            <div style="margin-top: 8px; display: flex; gap: 5px; position: relative;">
              <button id="btnPrevSeed" title="Previous Generation (←)" disabled
                style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 4px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button id="btnNextSeed" title="Next Generation (→)" disabled
                style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 4px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              <button id="btnToggleHistory" title="Full History List"
                style="flex: 0 0 32px; display: flex; justify-content: center; align-items: center; padding: 4px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <line x1="8" y1="6" x2="21" y2="6"></line>
                  <line x1="8" y1="12" x2="21" y2="12"></line>
                  <line x1="8" y1="18" x2="21" y2="18"></line>
                  <line x1="3" y1="6" x2="3.01" y2="6"></line>
                  <line x1="3" y1="12" x2="3.01" y2="12"></line>
                  <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
              </button>

              <!-- Floating History List -->
              <div id="seedHistoryList" style="display: none; position: absolute; top: 100%; right: 0; width: 220px; max-height: 200px;
                       overflow-y: auto; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; 
                       padding: 4px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                <!-- Populated via JS -->
                <div style="padding:8px; color:#888; text-align:center; font-size:0.8rem;">No history yet</div>
              </div>
            </div>
          </div>
        </div>

        <div class="control-group tile-selector-group">
          <label>Allowed Tiles</label>
          <div class="group-content"
            style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
            <div id="tileSelector">
              <!-- Javascript will populate this -->
            </div>
            <div class="row">
              <button id="selectAll">All</button>
              <button id="selectNone">None</button>
            </div>
          </div>
        </div>

      </div> <!-- End Tab Setup -->

      <!-- TAB CONTENT: EDIT -->
      <div id="tab-edit" class="tab-content">

        <!-- Interaction Controls -->
        <div class="control-group no-collapse">
          <!-- Scope Control -->
          <div id="scopeControl" style="margin-top: 0;">
            <div class="scope-header">
              <label style="font-size: 0.8rem; color: #aaa;">Target Scope</label>
            </div>
            <div class="scope-toggle-group">
              <!-- Single -->
              <button id="scopeSingle" class="scope-btn active" data-scope="single" title="Single Tile">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="scope-icon" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke-opacity="0.35"></rect>
                  <line x1="9" y1="3" x2="9" y2="21" stroke-opacity="0.25"></line>
                  <line x1="15" y1="3" x2="15" y2="21" stroke-opacity="0.25"></line>
                  <line x1="3" y1="9" x2="21" y2="9" stroke-opacity="0.25"></line>
                  <line x1="3" y1="15" x2="21" y2="15" stroke-opacity="0.25"></line>
                  <rect x="10" y="10" width="4" height="4" rx="0.8" fill="currentColor" stroke="none"></rect>
                </svg>
              </button>

              <!-- Supertile (Grid Block 2x2) -->
              <button id="scopeSupertile" class="scope-btn" data-scope="supertile" title="Block (2x2)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="scope-icon" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke-opacity="0.35"></rect>
                  <rect x="6" y="6" width="12" height="12" rx="1.6" stroke-opacity="0.8"></rect>
                  <line x1="12" y1="6" x2="12" y2="18"></line>
                  <line x1="6" y1="12" x2="18" y2="12"></line>
                  <rect x="7" y="7" width="4" height="4" rx="0.7" fill="currentColor" stroke="none"></rect>
                  <rect x="13" y="7" width="4" height="4" rx="0.7" fill="currentColor" stroke="none"></rect>
                  <rect x="7" y="13" width="4" height="4" rx="0.7" fill="currentColor" stroke="none"></rect>
                  <rect x="13" y="13" width="4" height="4" rx="0.7" fill="currentColor" stroke="none"></rect>
                </svg>
              </button>

              <!-- Global Exact Match (Magic selection) -->
              <button id="scopeGlobalExact" class="scope-btn" data-scope="global_exact" title="Global Match">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="scope-icon" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke-opacity="0.35"></rect>
                  <rect x="5" y="5" width="5" height="5" rx="1" fill="currentColor" stroke="none"></rect>
                  <rect x="14" y="5" width="5" height="5" rx="1" fill="currentColor" stroke="none"></rect>
                  <rect x="5" y="14" width="5" height="5" rx="1" fill="currentColor" stroke="none"></rect>
                  <line x1="12" y1="7.5" x2="12" y2="16.5" stroke-dasharray="2 2" stroke-opacity="0.6"></line>
                  <line x1="7.5" y1="12" x2="16.5" y2="12" stroke-dasharray="2 2" stroke-opacity="0.6"></line>
                </svg>
              </button>

              <!-- Global Position (Repetition pattern) -->
              <button id="scopeGlobalPos" class="scope-btn" data-scope="global_pos" title="Grid Position">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="scope-icon" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke-opacity="0.35"></rect>
                  <line x1="12" y1="3" x2="12" y2="21" stroke-opacity="0.2"></line>
                  <line x1="3" y1="12" x2="21" y2="12" stroke-opacity="0.2"></line>
                  <rect x="5" y="5" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="14" y="5" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="5" y="14" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="14" y="14" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                </svg>
              </button>

              <!-- Global Position Symmetric (Radial) -->
              <button id="scopeGlobalPosSym" class="scope-btn" data-scope="global_pos_sym" title="Symmetry (4x)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="scope-icon" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke-opacity="0.35"></rect>
                  <line x1="12" y1="3" x2="12" y2="21" stroke-opacity="0.2"></line>
                  <line x1="3" y1="12" x2="21" y2="12" stroke-opacity="0.2"></line>
                  <rect x="5" y="5" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="16" y="5" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="5" y="16" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                  <rect x="16" y="16" width="3" height="3" rx="0.6" fill="currentColor" stroke="none"></rect>
                </svg>
              </button>
            </div>

            <!-- Description Area (Dynamic) -->
            <div id="scopeDesc">
              <strong style="color: #ccc;">Single Tile:</strong> Only changes the specific tile you click.
            </div>

            <div id="editModeToggle" class="edit-mode-toggle" data-active="paint" aria-label="Edit action mode">
              <div class="edit-mode-bg" aria-hidden="true"></div>
              <button id="editModePaint" class="edit-mode-btn active" type="button"
                title="Paint (R alterna ferramenta)">Paint</button>
              <button id="editModeRotate" class="edit-mode-btn" type="button"
                title="Rotate (R alterna ferramenta)">Rotate</button>
            </div>
          </div>

          <!-- Paint Palette (Only visible for Paint Brush) -->
          <div id="paintTileDisplay" class="edit-paint-panel">
            <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Active Brush:</div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <!-- Preview Icon -->
              <div id="paintTilePreview"
                style="width: 30px; height: 30px; background: #333; border: 1px solid #555; border-radius: 4px; overflow: hidden;">
              </div>
              <span id="paintTileName" style="font-size: 0.9rem; font-weight: bold; color: #fff;"> Select below </span>
            </div>

            <div class="edit-brush-section">
              <label style="font-size: 0.8rem; color: #aaa; display:block; margin-bottom: 5px;">Brush Palette:</label>
              <div id="brushList" class="tile-list edit-brush-list">
                <!-- Brush tiles injected here -->
              </div>
            </div>
          </div>
        </div>

        <!-- History Controls for Edit -->
        <div class="control-group no-collapse" style="margin-bottom: 5px;">
          <div style="display: flex; gap: 5px;">
            <button id="btnUndo" title="Undo (Ctrl+Z)" disabled
              style="flex: 1; display: flex; justify-content: center; align-items: center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 14L4 9l5-5"></path>
                <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"></path>
              </svg>
              <span style="font-size: 0.8rem; margin-left: 5px;">Undo</span>
            </button>
            <button id="btnRedo" title="Redo (Ctrl+Shift+Z)" disabled
              style="flex: 1; display: flex; justify-content: center; align-items: center;">
              <span style="font-size: 0.8rem; margin-right: 5px;">Redo</span>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"></path>
                <path d="M15 14l5-5-5-5"></path>
              </svg>
            </button>
          </div>
          <div id="editHistoryState" class="edit-history-state">Step 1 / 1</div>
        </div>
      </div> <!-- End Tab Interact -->



      <div class="control-group actions">
        <button id="btnSave">Save Image</button>
        <button id="btnSaveSVG">Save SVG</button>
      </div>
    </div>

    <div id="canvas-container">
      <button id="btnFullscreen" title="Toggle Fullscreen"
        style="display:flex; justify-content:center; align-items:center;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
          </path>
        </svg>
      </button>
      <div id="canvasStatusHint">LMB paint • RMB rotate • Shift+RMB randomize</div>
    </div>
  </div> <!-- End main-container -->

  <script src="tile_registry.js"></script>
  <script src="tile_transforms.js"></script>
  <script src="subtile.js"></script>
  <script src="tiles.js"></script>
  <script src="supertile.js"></script>
  <script src="sketch.js"></script>
  <script>
    // Responsive Sidebar Logic
    document.addEventListener('DOMContentLoaded', () => {
      const btnToggle = document.getElementById('btnMobileToggle');
      const controls = document.getElementById('controls');
      const backdrop = document.getElementById('overlay-backdrop');
      const body = document.body;

      function toggleSidebar() {
        if (!controls) return;

        const isMobile = window.innerWidth <= 768; // Matches CSS breakpoint

        if (isMobile) {
          // Mobile behavior: Toggle drawer open/close
          const isOpen = controls.classList.contains('open');
          if (isOpen) {
            controls.classList.remove('open');
            if (backdrop) {
              backdrop.style.opacity = '0';
              setTimeout(() => backdrop.style.display = 'none', 300);
            }
          } else {
            controls.classList.add('open');
            if (backdrop) {
              backdrop.style.display = 'block';
              setTimeout(() => backdrop.style.opacity = '1', 10);
            }
          }
        } else {
          // Desktop behavior: Toggle visibility (Zen Mode vs Normal)
          const isClosed = controls.classList.contains('closed');
          if (isClosed) {
            controls.classList.remove('closed');
            body.classList.remove('sidebar-closed');
            btnToggle.classList.remove('closed-state');
          } else {
            controls.classList.add('closed');
            body.classList.add('sidebar-closed');
            btnToggle.classList.add('closed-state');
          }
        }
      }

      if (btnToggle) btnToggle.addEventListener('click', toggleSidebar);

      // Close on backdrop click (for mobile)
      if (backdrop) backdrop.addEventListener('click', toggleSidebar);

      // Handle resize to reset states if needed
      window.addEventListener('resize', () => {
        // Optional: Reset states if crossing breakpoint to avoid weirdness
        // For now, simpler is better.
      });

      // Tab Switching Logic
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from buttons
          tabs.forEach(t => t.classList.remove('active'));
          // Add active to clicked
          tab.classList.add('active');
          // Add attribute to parent for animation
          tab.parentElement.setAttribute('data-active', tab.getAttribute('data-tab'));

          // Hide all contents
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          // Show target content
          const targetId = 'tab-' + tab.getAttribute('data-tab');
          document.getElementById(targetId).classList.add('active');

          // Trigger custom event for Sketch.js to pick up
          window.dispatchEvent(new CustomEvent('tabChanged', { detail: { tab: tab.getAttribute('data-tab') } }));
        });
      });

      // Update summary helper - Global so Sketch.js can call it
      window.updateSummary = function (group) {
        if (!group) return;
        const summary = group.querySelector('.group-summary');
        if (!summary) return;

        const inputs = group.querySelectorAll('input[type="number"]');

        // Custom logic based on group context
        if (inputs.length === 2) {
          summary.textContent = `${inputs[0].value} x ${inputs[1].value}`;
        } else if (inputs.length === 1) {
          // Check for specific inputs to add units
          if (inputs[0].id === 'gridMargin') {
            summary.textContent = `${inputs[0].value} px`;
          } else {
            summary.textContent = inputs[0].value;
          }
        }
      }

      window.updateAllSummaries = function () {
        document.querySelectorAll('.control-group').forEach(group => {
          window.updateSummary(group);
        });
      }

      // Accordion Logic
      document.querySelectorAll('.control-group:not(.tile-selector-group):not(.no-collapse) > label').forEach(label => {
        // Initial summary update
        window.updateSummary(label.parentElement);

        label.addEventListener('click', (e) => {
          e.preventDefault();
          const group = label.parentElement;
          group.classList.toggle('collapsed');
        });
      });

      // Listen for input changes to update summaries
      document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
          const group = e.target.closest('.control-group');
          window.updateSummary(group);
        }
      });

      // Listen for seed updates (programmatic changes)
      const seedInput = document.getElementById('seedInput');
      // Observer for value changes if JS updates it without input event
      // Or just patch into Sketch.js render, but let's try a simple interval or custom event if needed.
      // Actually, standard input event bubbles. Programmatic value changes don't trigger input.
      // We can rely on Sketch.js triggering UI updates.

    });
  </script>
</body>

</html>